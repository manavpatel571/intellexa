<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards - Intellexa</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #F7F2EB;
            min-height: 100vh;
        }

        .header {
            background: #FFFFFF;
            box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 40px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 700;
            font-size: 32px;
            color: #081F5C;
            text-decoration: none;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 12px;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .upload-btn {
            padding: 12px 20px;
            background: #334EAC;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            color: #FFFFFF;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .upload-btn:hover {
            background: #1e3a8a;
            transform: translateY(-2px);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #334EAC;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(51, 78, 172, 0.3);
        }

        .nav-buttons {
            position: relative;
        }

        .profile-dropdown {
            position: absolute;
            top: 60px;
            right: 0;
            background: #FFFFFF;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            min-width: 180px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .profile-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #374151;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .dropdown-item:hover {
            background: #F3F4F6;
            color: #334EAC;
        }

        .dropdown-item i {
            width: 16px;
            color: #6B7280;
        }

        .dropdown-item:hover i {
            color: #334EAC;
        }

        .main-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 120px 40px 40px;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #334EAC;
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 30px;
            transition: color 0.3s ease;
        }

        .back-button:hover {
            color: #1e3a8a;
        }

        .flashcards-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .flashcards-title {
            font-size: 36px;
            font-weight: 700;
            color: #081F5C;
            margin-bottom: 20px;
        }

        .flashcards-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card-counter {
            font-size: 18px;
            color: #6B7280;
            font-weight: 600;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            background: white;
            color: #6B7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            border-color: #334EAC;
            color: #334EAC;
        }

        .control-btn.active {
            border-color: #334EAC;
            background: #334EAC;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #E5E7EB;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 40px;
        }

        .progress-fill {
            height: 100%;
            background: #334EAC;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .flashcard-container {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            perspective: 1000px;
        }

        .flashcard {
            width: 100%;
            max-width: 600px;
            height: 400px;
            background: #FFFFFF;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.6s ease;
            transform-style: preserve-3d;
            position: relative;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-front,
        .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            border-radius: 16px;
        }

        .flashcard-front {
            background: #FFFFFF;
        }

        .flashcard-back {
            background: #F8FAFC;
            transform: rotateY(180deg);
        }

        .card-content {
            text-align: center;
        }

        .card-question {
            font-size: 24px;
            font-weight: 600;
            color: #081F5C;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .card-answer {
            font-size: 20px;
            font-weight: 500;
            color: #374151;
            line-height: 1.5;
        }

        .card-hint {
            font-size: 16px;
            color: #6B7280;
            font-style: italic;
            margin-top: 20px;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .nav-btn {
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-previous {
            background: transparent;
            color: #334EAC;
            border: 2px solid #334EAC;
        }

        .btn-previous:hover:not(:disabled) {
            background: #334EAC;
            color: white;
        }

        .btn-show-answer {
            background: #334EAC;
            color: white;
            border: 2px solid #334EAC;
        }

        .btn-show-answer:hover {
            background: #1e3a8a;
            transform: translateY(-2px);
        }

        .btn-next {
            background: transparent;
            color: #334EAC;
            border: 2px solid #334EAC;
        }

        .btn-next:hover:not(:disabled) {
            background: #334EAC;
            color: white;
        }

        .flashcards-complete {
            text-align: center;
            padding: 60px 40px;
            background: #FFFFFF;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .complete-title {
            font-size: 36px;
            font-weight: 700;
            color: #081F5C;
            margin-bottom: 20px;
        }

        .complete-subtitle {
            font-size: 18px;
            color: #6B7280;
            margin-bottom: 40px;
        }

        .complete-actions {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #334EAC;
            color: white;
            border: 2px solid #334EAC;
        }

        .btn-primary:hover {
            background: #1e3a8a;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: transparent;
            color: #334EAC;
            border: 2px solid #334EAC;
        }

        .btn-secondary:hover {
            background: #334EAC;
            color: white;
        }

        @media (max-width: 768px) {
            .header-container {
                padding: 0 20px;
            }

            .main-container {
                padding: 120px 20px 40px;
            }

            .flashcards-title {
                font-size: 28px;
            }

            .flashcard {
                height: 300px;
            }

            .card-question {
                font-size: 20px;
            }

            .card-answer {
                font-size: 18px;
            }

            .navigation {
                flex-direction: column;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="{{ url_for('dashboard') if session.get('logged_in') else url_for('home') }}" class="logo">
                <div class="logo-icon">
                    <img src="{{ url_for('static', filename='logo.png') }}" alt="Intellexa Logo">
                </div>
                Intellexa
            </a>
            <div class="nav-buttons">
                <a href="#" class="upload-btn">
                    <i class="fas fa-plus"></i>
                    Upload New
                </a>
                <div class="user-avatar" onclick="toggleProfileDropdown()">{{ user_name[0:2].upper() }}</div>
                <div class="profile-dropdown" id="profileDropdown">
                    <a href="{{ url_for('dashboard') }}" class="dropdown-item">
                        <i class="fas fa-book"></i>
                        My Library
                    </a>
                    <a href="{{ url_for('growth_dashboard') }}" class="dropdown-item">
                        <i class="fas fa-chart-line"></i>
                        Dashboard
                    </a>
                    <a href="{{ url_for('logout') }}" class="dropdown-item">
                        <i class="fas fa-sign-out-alt"></i>
                        Log Out
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Back Button -->
        <a href="{{ url_for('study_material', material_id=material_id) }}" class="back-button">
            <i class="fas fa-arrow-left"></i>
            Back to Material
        </a>

        <!-- Flashcards Header -->
        <div class="flashcards-header">
            <h1 class="flashcards-title">{{ material.title if material else 'Flashcards' }}</h1>
            <div class="flashcards-controls">
                <span class="card-counter">Card <span id="current-card">1</span> of <span id="total-cards">5</span></span>
                <div class="control-buttons">
                    <button class="control-btn" id="shuffle-btn" onclick="toggleShuffle()" title="Shuffle cards">
                        <i class="fas fa-random"></i>
                    </button>
                    <button class="control-btn" id="settings-btn" onclick="openSettings()" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-bar"></div>
            </div>
        </div>

        <!-- Flashcards Content -->
        <div id="flashcards-content">
            <div class="flashcard-container">
                <div class="flashcard" id="flashcard" onclick="flipCard()">
                    <div class="flashcard-front">
                        <div class="card-content">
                            <div class="card-question" id="card-question">What type of data does supervised learning use?</div>
                            <div class="card-hint">click to reveal answer</div>
                        </div>
                    </div>
                    <div class="flashcard-back">
                        <div class="card-content">
                            <div class="card-answer" id="card-answer">Supervised learning uses both input data (features) and output data (labels) to train models. The algorithm learns the mapping between inputs and outputs so it can make predictions on new, unseen data.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flashcards Complete -->
        <div id="flashcards-complete" class="flashcards-complete" style="display: none;">
            <h1 class="complete-title">Flashcards Complete!</h1>
            <p class="complete-subtitle">Great job! You've reviewed all the flashcards for this topic.</p>
            <div class="complete-actions">
                <button class="action-btn btn-primary" onclick="restartFlashcards()">
                    <i class="fas fa-redo"></i>
                    Review Again
                </button>
                <button class="action-btn" onclick="generateMoreFlashcards()" style="background: #10b981;">
                    <i class="fas fa-plus"></i>
                    Generate More
                </button>
                <a href="{{ url_for('study_material', material_id=material_id) }}" class="action-btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Back to Material
                </a>
            </div>
        </div>

        <!-- Navigation -->
        <div class="navigation" id="navigation">
            <button class="nav-btn btn-previous" id="btn-previous" onclick="previousCard()">
                <i class="fas fa-arrow-left"></i>
                Previous
            </button>
            <button class="nav-btn btn-show-answer" id="btn-show-answer" onclick="flipCard()">
                Show Answer
            </button>
            <button class="nav-btn btn-next" id="btn-next" onclick="nextCard()">
                Next
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Generation Options Modal -->
    <div id="optionsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9998; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; padding: 30px; max-width: 400px; text-align: center;">
            <h2 style="font-size: 24px; color: #081F5C; margin-bottom: 20px;">Flashcards Setup</h2>
            <p style="color: #6B7280; margin-bottom: 20px;">How many flashcards would you like?</p>
            <p style="color: #9CA3AF; font-size: 14px; margin-bottom: 20px;">ðŸ’¡ Select the same number to review existing, or a different number to generate more!</p>
            <select id="numCardsSelect" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 16px; margin-bottom: 20px;">
                <option value="5">5 flashcards</option>
                <option value="10" selected>10 flashcards</option>
                <option value="15">15 flashcards</option>
                <option value="20">20 flashcards</option>
            </select>
            <div style="display: flex; gap: 10px;">
                <button onclick="closeOptionsModal()" style="flex: 1; padding: 12px; background: #E5E7EB; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
                <button onclick="confirmGeneration()" style="flex: 1; padding: 12px; background: #334EAC; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Generate</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
        <div style="text-align: center; color: white;">
            <div class="spinner" style="margin: 0 auto 20px;"></div>
            <h2 style="font-size: 24px; margin-bottom: 10px;">Generating Flashcards...</h2>
            <p style="font-size: 16px; opacity: 0.8;">AI is creating <span id="generatingCount">10</span> flashcards. This may take a moment.</p>
        </div>
    </div>

    <script>
        // Flashcards data from database
        let flashcardsData = [
            {% for card in flashcards %}
            {
                question: {{ card.question|tojson }},
                answer: {{ card.answer|tojson }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        
        let existingCardCount = flashcardsData.length;
        
        // Check if we just generated content (skip modal if so)
        const justGenerated = sessionStorage.getItem('justGeneratedFlashcards');
        
        // Always show options modal on load (unless we just generated)
        document.addEventListener('DOMContentLoaded', function() {
            if (justGenerated) {
                // Clear flag and start directly
                sessionStorage.removeItem('justGeneratedFlashcards');
                if (flashcardsData.length > 0) {
                    initFlashcards();
                } else {
                    showOptionsModal();
                }
            } else {
                showOptionsModal();
            }
        });
        
        function showOptionsModal() {
            document.getElementById('optionsModal').style.display = 'flex';
            // Pre-select the current count if exists
            if (existingCardCount > 0) {
                const select = document.getElementById('numCardsSelect');
                const currentOption = select.querySelector(`option[value="${existingCardCount}"]`);
                if (currentOption) {
                    select.value = existingCardCount;
                }
            }
        }
        
        function closeOptionsModal() {
            document.getElementById('optionsModal').style.display = 'none';
            // If no cards exist, go back
            if (existingCardCount === 0) {
                window.location.href = '/study/{{ material_id }}';
            } else if (isGeneratingMore) {
                // If canceling from "Generate More", show completion screen again
                document.getElementById('flashcards-complete').style.display = 'block';
                isGeneratingMore = false;
            } else {
                // Otherwise, just show existing cards
                initFlashcards();
            }
        }
        
        function confirmGeneration() {
            const numCards = parseInt(document.getElementById('numCardsSelect').value);
            document.getElementById('optionsModal').style.display = 'none';
            isGeneratingMore = false; // Reset flag
            
            // If same number as existing, just show existing cards (or back to completion)
            if (numCards === existingCardCount) {
                initFlashcards();
                return;
            }
            
            // If different, generate (will add more or regenerate all)
            document.getElementById('generatingCount').textContent = numCards;
            generateFlashcardsNow(numCards);
        }
        
        function generateFlashcardsNow(numCards = 10) {
            // Show loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';
            
            // Set flag to skip modal after reload
            sessionStorage.setItem('justGeneratedFlashcards', 'true');
            
            // Call backend to generate flashcards
            fetch('/generate_flashcards_for_material', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    material_id: {{ material_id }},
                    num_cards: numCards
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.flashcards && data.flashcards.length > 0) {
                    flashcardsData = data.flashcards;
                    // Keep loading overlay visible during reload
                    // Reload the page to show flashcards
                    location.reload();
                } else {
                    loadingOverlay.style.display = 'none';
                    sessionStorage.removeItem('justGeneratedFlashcards');
                    alert('Failed to generate flashcards. Please try again or go back.');
                    window.location.href = '/study/{{ material_id }}';
                }
            })
            .catch(error => {
                loadingOverlay.style.display = 'none';
                sessionStorage.removeItem('justGeneratedFlashcards');
                alert('Error generating flashcards: ' + error.message);
                window.location.href = '/study/{{ material_id }}';
            });
        }
        
        let isGeneratingMore = false;
        
        function generateMoreFlashcards() {
            // Hide completion screen
            document.getElementById('flashcards-complete').style.display = 'none';
            isGeneratingMore = true;
            // Show options modal
            showOptionsModal();
        }

        let currentCardIndex = 0;
        let isShuffled = false;
        let isCardFlipped = false;
        let cardOrder = [...Array(flashcardsData.length).keys()];

        // Initialize flashcards
        function initFlashcards() {
            // Reset card order to match current flashcardsData length
            cardOrder = [...Array(flashcardsData.length).keys()];
            currentCardIndex = 0;
            isCardFlipped = false;
            
            displayCard();
            updateProgress();
        }

        // Display current card
        function displayCard() {
            const cardIndex = cardOrder[currentCardIndex];
            const card = flashcardsData[cardIndex];
            
            document.getElementById('card-question').textContent = card.question;
            document.getElementById('card-answer').textContent = card.answer;
            document.getElementById('current-card').textContent = currentCardIndex + 1;
            
            // Reset card flip state
            isCardFlipped = false;
            document.getElementById('flashcard').classList.remove('flipped');
            
            updateNavigation();
        }

        // Flip card
        function flipCard() {
            const flashcard = document.getElementById('flashcard');
            isCardFlipped = !isCardFlipped;
            
            if (isCardFlipped) {
                flashcard.classList.add('flipped');
                document.getElementById('btn-show-answer').textContent = 'Show Question';
            } else {
                flashcard.classList.remove('flipped');
                document.getElementById('btn-show-answer').textContent = 'Show Answer';
            }
        }

        // Navigate to next card
        function nextCard() {
            if (currentCardIndex < flashcardsData.length - 1) {
                currentCardIndex++;
                displayCard();
                updateProgress();
            } else {
                // Flashcards complete
                completeFlashcards();
            }
        }

        // Navigate to previous card
        function previousCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                displayCard();
                updateProgress();
            }
        }

        // Update progress bar
        function updateProgress() {
            const progress = ((currentCardIndex + 1) / flashcardsData.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('total-cards').textContent = flashcardsData.length;
        }

        // Update navigation buttons
        function updateNavigation() {
            const isFirstCard = currentCardIndex === 0;
            const isLastCard = currentCardIndex === flashcardsData.length - 1;
            
            document.getElementById('btn-previous').disabled = isFirstCard;
            
            if (isLastCard) {
                document.getElementById('btn-next').textContent = 'Complete';
            } else {
                document.getElementById('btn-next').textContent = 'Next';
            }
        }

        // Toggle shuffle
        function toggleShuffle() {
            isShuffled = !isShuffled;
            const shuffleBtn = document.getElementById('shuffle-btn');
            
            if (isShuffled) {
                shuffleBtn.classList.add('active');
                shuffleCards();
            } else {
                shuffleBtn.classList.remove('active');
                cardOrder = [...Array(flashcardsData.length).keys()];
            }
            
            currentCardIndex = 0;
            displayCard();
            updateProgress();
        }

        // Shuffle cards
        function shuffleCards() {
            cardOrder = [...Array(flashcardsData.length).keys()];
            for (let i = cardOrder.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cardOrder[i], cardOrder[j]] = [cardOrder[j], cardOrder[i]];
            }
        }

        // Open settings
        function openSettings() {
            alert('Settings: You can adjust flashcard speed, difficulty, and review intervals here.');
        }

        // Complete flashcards
        function completeFlashcards() {
            document.getElementById('flashcards-content').style.display = 'none';
            document.getElementById('navigation').style.display = 'none';
            document.getElementById('flashcards-complete').style.display = 'block';
        }

        // Restart flashcards
        function restartFlashcards() {
            currentCardIndex = 0;
            isCardFlipped = false;
            
            if (!isShuffled) {
                cardOrder = [...Array(flashcardsData.length).keys()];
            } else {
                shuffleCards();
            }
            
            document.getElementById('flashcards-content').style.display = 'block';
            document.getElementById('navigation').style.display = 'flex';
            document.getElementById('flashcards-complete').style.display = 'none';
            
            initFlashcards();
        }

        // Note: Modal shows first on page load, then initFlashcards() is called from closeOptionsModal() or confirmGeneration()

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profileDropdown');
            const avatar = document.querySelector('.user-avatar');
            
            if (!avatar.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
    </script>
</body>
</html>
